# 账户系统设计

## 互联网账户系统如何设计

在很多互联网公司业务发展的早期，业务模式比较单一的情况下，涉及用户账户资金交易相关的逻辑也比较简单，但是随着公司业务模式的不断创新及类型的多元化发展，会渐渐发现现有系统账户逻辑越来越雍肿，不仅难以支持新业务的扩张，对现有业务的支持也适配困难，最终导致新业务系统不得不重新搭建自己的业务账户逻辑，造成重复建设不说，也往往给后续的财务资金核算造成混乱。

以某互联网A租车公司的业务发展路径为例?

阶段A

A公司在早期开展租车业务时根据用户使用场景规定用户必须在缴纳押金以后才可以租车，并且支持用户进行余额充值，余额可以支付租车费用以及购买相关优惠产品。所以账户资金流是这样子的：

 ![账户1](png\账户\账户1.png)



 

通过上述设计基本上就满足了简单的业务需求，用户缴纳押金单独存放在一个押金账户，用户的每次押金冲退都记录账户流水(缴押金记+，退押金记-)；用户余额充值单独存放在一个余额账户，用户的每次余额充值、消费、退款都记录账户流水（余额充值记+、余额消费记-、余额退款记-）。

事实上，以上账户逻辑的设计基本已经能满足业务早期的发展的需要了，并且如果账户流水记录完整（例如记录必要的业务类型，如余额购买了一张租车次卡）那么后续也能基本满足早期业务的财务核算需求。遗憾的是，很多公司在类似以上简单账户逻辑的设计上都比较混乱，如有的公司将账户直接绑定在用户信息表上、有些直接更新账户余额，没有完整记录账户流水或账户流水记录业务信息缺乏等，这种情况即使业务没有多元化发展，也很难满足后续业务逻辑的扩展，特别是会造成严重的财务数据核算困难，更不用谈业务多元化发展后如何能够快速支撑了，造成这种问题的原因是多方面的，这里也就不在赘述。

下面我们继续看A公司租车业务的发展演进情况！

假设在A公司租车业务发展过程中为了鼓励用户进行余额充值，采用了充值+返现的形式进行活动，如：“充值100赠送20”，此时用户余额账户的总金额应该是120，那么账户逻辑如何支持呢？

 ![账户2](png\账户\账户2.png)



 

这里注意，之所以需要区分余额中真实充值和赠送的原因在于，如果产品逻辑允许余额退款，那么清晰地区分了真实充值和赠送所对应的余额的话，退款逻辑的实现将会比较简单，否则就会变得比较痛苦，并且不清晰的逻辑也会增加造成公司资金损失的风险；另外如果余额返现账户变动流水记录得比较明确的话，对财务后续的收入核算也会方便很多。

但是，是否这样就能满足业务需求了呢？

显然，这样还不能让逻辑完全运行起来，因为增加了账户相应地交易逻辑与资金逻辑都需要进行相应的改变才行，以上业务场景中原来余额充值只需要调用余额账户记账一次，现在需要根据充返逻辑再调用余额返现账户记账一次；而余额消费则需要根据业务规则进行余额消费记账，假设业务规则为“余额消费优先扣减余额返现账户，再次扣减余额账户”，那么系统交易及记账逻辑如下图所示：

 ![账户3](png\账户\账户3.png)



 

从逻辑上看业务交易系统需要根据业务规则多次调用余额账户及余额返现账户进行记账，并且需要从流程上保证两个账户记账调用的事务一致性，例如一笔消费订单金额为20元，此时余额账户余额为10元，余额返现账户余额为5元，在优先消费返现账户金额扣款5元后无法再从余额账户消费15元时，交易失败后需要回滚余额返现账户消费逻辑,余额返现账户“交易冲正 +5”。

阶段B

在阶段A中，单个业务会根据不同的产品设计进行账户逻辑的迭代，增加余额充返账户后虽然从账户逻辑层面只是增加了新的资金账户，但是交易逻辑却是进行了较大的变更和调整；如果此时该业务场景又出现新的逻辑变化，例如某一天该租车业务针对某些信用良好的用户进行免押金用车活动，并且支持这类用户在退押金时可以选择将押金的全部或部分金额进行余额充值，那么在流程设计上还会存在账户转账的情况（押金账户->余额账户）。

每次产品业务的迭代涉及用户资金逻辑，都不免会影响交易逻辑及账户逻辑本身，但如果业务品类单一，这种迭代及扩展通过硬编码方式多少还能继续支持。但是，如果随着公司业务向多元化发展，问题往往就变得复杂了。

假设A公司在主营租车业务发展态势进入到趋于平缓的阶段后，为了扩展业务范围需要尝试新的业务，例如，某团队提出不能仅仅只搞租车也得弄个网约车平台，那怎么弄？

首先肯定是需要先集结队伍啦。集结完队伍就需要好好分析分析下业务场景了，我们先大概看看一个网约车平台的大概业务场景是什么样子的，其中涉及的资金交易的流程应该如何设计呢？

在A公司的租车业务中，从参与角色角度来看涉及的逻辑并不算太复杂，只有“用户、车、租车公司(内部可称租车业务线)”，而从交易场景上看，用户缴纳押金、预存余额及余额消费都只是单向的C->B交易模型，如果不考虑公司层在线交易账户体系（这里是指公司层面的交易账户）业务复杂度还不算十分复杂，并且在这种单向业务模式下，没有公司层面的在线交易账户本身并不影响业务流程，收入核算只需要线下计算即可，这也就是为什么前面会特意强调账户流水业务关键信息不能缺失的原因了。

 而约车业务则是多向的C->B-C-B的交易模型，因为从参与角色上看除了普通打车用户外，还有司机、打车平台都会紧紧地参与到整个业务流程中；而从账户资金流上看用户支付的车费不会以C->C的模式直接支付给司机，而是会由打车平台代收，打车平台扣除订单抽成后剩下的车费才会打到司机在打车平台开的账户上，司机才能从个人账户提现。

 ![账户4](png\账户\账户4.png)从上图的分析中我们可以看到，我们需要为普通用户、司机账户、打车平台分别设置必要的账户逻辑，普通用户账户逻辑与之前的租车业务比较类似，用户可以直接支付打车费用、也可以通过余额充值后使用余额支付打车费用；而平台则需要代收用户的打车费用并且需要按照服务规则从代收的打车费用中扣掉部分服务费，然后通过代收/付平台账户将车费实时结算给司机端收款账户，司机通过个人收款账户发起提现后经过结算账户完成提现。资金流如下：

 ![账户5](png\账户\账户5.png)

此外，为了满足产品逻辑的扩张，例如要具备冻结司机账户的业务功能，则需要设置冻结账户；平台为了进行市场营销活动，如发放红包则需要设置平台市场营销账户等。

 阶段C

 业务发展到这个阶段，初步看好像并没有太多的逻辑变动，并且看着只需要扩展下之前租车业务的账户逻辑就好了。但真的是这样吗？

 事实上从单纯的产品逻辑来看，同一套个人用户账户貌似是没有什么问题的，但是根据很多互联网公司业务发展的路径来看，不同的业务线根据发展情况不同往往会分别设置不同的法律主体，而且根据业务性质的不同监管层面的政策也是完全不一样的，例如在国内运营的租车业务司机车费代收代发这类业务是要求运营公司具备支付牌照的，没有则会牵扯到非法二清这样的法律风险，而一般来说在没有支付牌照又想继续运营的话，替代方案目前主要是采用银行资金托管的方式，即用户资金通过银行三类账户进行托管。

 一旦涉及这类业务，整个系统的业务复杂度会成倍地增长，所以如果采用同一套个人用户账户的话，资金流将会变得难以拆分，对整个系统的升级也会造成比较大的困扰。

 另外如果除了租车业务、打车业务外又尝试了别的新业务，如直播之类。业务类型完全不同，且财务本身就要求进行分类的话，只能重新设计新的账户逻辑了；但，从某种角度看这类账户逻辑实质上又是与之前业务存在共性的。如直播类平台也是普通用户充值，购买平台礼物后打赏给主播，此时平台会对用户赠送的礼物抽成后将其转换为可提现的余额结算给主播账户，这类账户逻辑与约车平台其实是很类似的。

 那么，是否存在既能统一财务数据又能良好地支持业务的横向扩展相对通用的账户系统模型呢？

 接下来继续和大家探讨一套可以持续扩展的业务账户系统该如何设计？

 业务模型

 首先我们分析下大多数在线资金业务涉及的逻辑实体，用户是第一存在，但是用户根据参与的性质不同又分为普通消费端用户、普通服务端用户，拿打车来说一个普通打车的人属于普通消费端用户，而司机个人则属于普通消费用户，并且司机身份也是可以转换为普通打车用户，另外就是平台用户，是指公司内部各个不同的业务主体，它们关联的法律主体可能是同一个也可能是不同的。

 所以综上所说，我们需要的可能是一套“为不同公司主体下，不同业务的同一个／不同用户提供不同账户交易逻辑支撑，并且可以满足业务及用户平滑扩张的系统”。

 事实上要达到这样的效果是很难的，需要在系统平台层面进行良好地系统及业务架构设计，并且确保在制定业务规则时遵循一定的制度及规范才行。

 以下图示为目前业内相对比较完整的通用账户体系模型，俗称“三户模型”，最早是电信行业为适配复杂通信业务场景而设计的一套账户体系模型；而大部分互联网公司业务的复杂度是低于复杂的电信业务的，所以在这里我们对此模型进行部分改进，以期形成适应互联网公司业务发展的通用账户体系模型。

 ![账户6](png\账户\账户6.png)

在上述模型中信息被划分成了三个类型：客户、用户、账户。客户是用户身份信息的承载实体，例如张三这个人是一个客户；而客户也不仅仅只是针对个人，针对业务线所关联的法律主体也划分在客户的范畴，如某某打车公司。而有了基本的客户信息后，企业客户具体可以开展什么业务，普通个人用户是否使用了该企业客户提供的服务，在模型中是采用用户这个概念来承载的。企业客户开展该业务时根据业务的设计需要开通什么平台账户，普通个人用户使用该业务服务需要开通什么样的个人账户都可以根据业务的设计通过用户下设立相应地账户进行隔离区分。

 假设此时A公司的租车业务与打车业务法律主体尚未进行拆分属于同一家公司，但是财务上要求隔离两类业务的资金流，那么可以在账户系统上为租车业务开立租车业务用户，如果张三使用了租车业务则为张三设置租车业务用户并在该用户下开立余额、余额返现、押金三类账户并配置业务及记账规则，此外若希望业务资金在平台上也有个完整体现也可以在租车业务用户下设立相应的平台账户，只是业务流程上可以采用缓冲或异步记账的方式。

 而打车业务则需要根据普通客户信息为普通打车用户开立相应的个人账户，若是司机则需要开通司机相关的业务账户，而平台也需要开通相应的平台账户。在信息流上，客户信息为所有业务所共用，用户信息则是根据不同的业务设置，账户是根据业务挂在相应地业务用户下。如若各业务间没有横向地联系，各业务层账户体系根据自身业务分别运行、互不干扰，而如果存在联系，如租车余额可以进行打车，则可以设计为允许业务层间账户的互转，只是这种资金流会更复杂，需要配置的记账分录也会更加复杂。

 以上述模型的定义而设计的账户系统会初步形成一个具备支持多类业务账户逻辑并行的通用中台账户系统雏形，从财务角度看账户层次会相对清晰。另外，图中还定义了机构的概念以支持总公司-分公司这样具备层级关系的财务核算需求，当然这种情况在互联网公司的扁平化模式下并不常见，所以可以暂时忽略。

 本篇通过业务场景举例从业务模型上大概阐述了互联网账户系统如何设计得相对通用和清晰，事实上在系统设计上也需要进行更多的设计，并且需要根据公司实际业务情况进行一定的取舍。







在上一篇文章中我们通过场景举例的方式，讨论了一套相对通用的互联网业务账户系统，从业务模型上应该如何定义。那么除了从业务模型上进行定义外，在具体系统实现上又该如何设计？又有哪些需要注意的地方呢？在本篇内容中小码农就和大家一起讨论下账户系统的实现细节，希望可以和大家一起交流进步。

 事实上账户系统的业务逻辑是比较复杂的，对**数据的一致性要求很高**，特别是记账动作涉及强事务特性；另外，性能问题也是常常制约账户系统稳定性的一个比较突出的方面。在这种情况下，我们还需要考虑系统的业务通用性设计问题，而这必然也会涉及很多配置项的设计，增加系统的逻辑复杂度。但是，也只有处理好了这些问题，账户系统才能保证业务的持续扩张，否则再好的理念也只是空中楼阁。然而，处理好这些复杂的问题，事实上并不只是某一点的设计就可以达成的，既需要逻辑流程设计上的优化，也需要采用合适的技术方案，更需要一个合理的系统结构。 

下面我们就从**系统结构、整体流程、数据模型、记账规则，以及日终对账**这几个方面与大家探讨从系统层面应该如何设计。另外对于账户系统中制约性能最常见的**热点账户**问题，也会和大家一起探讨。

**系统结构**

 在之前的内容中，我们提到要设计一套可以满足互联网业务扩展的账户系统，所以账户是这套系统的基础，为了更好地支持不同业务、或同一业务不同账户的开户，我们需要将开户逻辑设计成独立的子系统，独立地提供包括开户、账户信息查询、余额查询在内的服务，以便逻辑复杂到一定阶段后可以更容易的扩展。在完成开账户动作后，就需要根据业务规则，设计好逻辑体系下不同交易类型的记账规则了，而这种规则配置是否智能，则是账户系统是否通用的关键；配置完规则后账户系统就可以接收业务发起的交易请求，并根据规则的配置完成业务资金流的处理了，所以，从系统结构层面也需要将记账核心服务设计成独立的子系统；此外，为了适配业务层不同的交易类型，主要是隔离记账逻辑与交易逻辑，还需要前置账户交易系统。 

最后，为了确保账户余额与流水之间的平衡，我们还需要在日终时对主要资金账户进行对账核算，确保账户流水发生额与账户余额的一致性。所以从系统结构层面，整个系统主要可以分为四个部分：

 ![账户7](png\账户\账户7.png)

之所以在账户系统、核心记账系统之上设置一层账户层交易系统，是为了将多变的业务交易逻辑与相对通用的记账逻辑进行隔离，避免在核心记账系统中冗余过多的业务逻辑导致后续出现臃肿的情况。例如业务层的交易类型可能是复杂多变的，如车费充值、押金支付之类，而这样的逻辑是没有必要让记账系统感知的，记账系统只需要根据交易系统传递的记账规则，根据会计分录完成资金流处理即可。

 **整体流程
**为了确保系统能够正常Run起来，需要对系统整体的流程进行规划，这部分流程即包括线下流程，也包括线上流程，它是确保整个系统闭环的基础。例如，以账户系统需要支撑A公司打车业务为例，假设账户系统已经存在的情况下，那么它需要支撑这个业务应该经历以下两个阶段的流程：

**（一）、线下规划配置流程**

 ![账户8](png\账户\账户8.png)

按照正常的流程设计，在业务开展之前，需要根据实际的业务资金流设计好具体的账户及交易资金逻辑，这部分逻辑一般是由PM与资金部门线下确认后形成正式的产品规格文档。之后，由具有权限的运营人员通过后台，或者前期在没有完善配置系统的情况下，由技术人员初始化到系统中，由于这部分配置关系到交易核心流程，所以**在流程及操作规范的制定上要严格把控**，避免配置错误导致的严重系统逻辑错乱问题。

在这部分流程中我们首先需要配置业务主体，这里需要为A公司配置客户开户信息，之后需要按照之前业务模型定义的结构，在客户下为其开通表示打车业务线网约车用户，至此在系统中就完成了**“谁？要干什么？**”的定义。而具体**“怎么干？”，**则是在后面我们要重点配置的内容。

**那么具体需要配置什么内容呢？**

因为，账户系统本身是为交易逻辑服务的，所以我们需要明确业务中涉及账户逻辑的交易有哪些类型，例如在约车业务中主要涉及到**司机端开户**、**乘客开户、现金支付车费、余额充值、余额支付车费、司机提现**等这些交易类型，所以我们需要为这些交易类型定义交易编码（tradeCode），并将其与之前开通的网约车业务用户进行关联，这样在后续的系统交易流程中，就可以进行交易权限控制，各业务线逻辑各自关联自身的交易类型，以免互相干扰了。

而定义了这些交易类型以后，账户层交易系统具体接收到这样的交易请求后应该怎样执行逻辑呢？在互联网公司早期业务发展的过程中，很多都是将账户逻辑与交易逻辑耦合在一起的，这样会导致各个业务账户逻辑陷入要么继续耦合，要么各自定制、重复开发的怪圈。

而要让这种逻辑变得通用，就需要将其**规则化**，即账户层交易系统接收到指定的交易请求类型后，会根据系统用户交易规则配置，获取开户、记账交易规则信息，然后记账系统和开户系统就会按照规则指定的逻辑执行了，这种执行逻辑识别规则，不感知具体业务逻辑。在上述流程中，我们将“平台层开户”也设计成了规则，只是这种开户动作接口并不对实时交易接口开放，一般是通过后台设置，即通过后台调用开户系统机构（平台）开户接口，开户逻辑根据网约车平台层开户规则，自动开立**“服务费账户”、“代收付平台账户”、“结算账户”、“市场营销账户”**这类开展网约车业务所需的平台层账户体系。

其他开户交易类型，如司机端开户、乘客开户由于需要在具体用户注册、司机入驻时通过实时交易接口自动调用Api开通，所以这里需要配置好开户规则即可；至于，各个涉及资金变动的交易类型，如车费支付、余额充值之类，涉及到具体的记账规则的逻辑，也需要通过配置相应的交易记账规则，关于记账规则的配置设计涉及一点会计知识的细节，会在后面的内容中介绍到。

**（二）、线上系统交易流程**

完成系统级的数据定义及规则配置后，整个账户系统就会通过开放Api，为各个业务交易系统提供线上账户交易接口服务了。

![账户9](png\账户\账户9.png)

业务层交易系统向账户层交易系统发起交易请求后，系统会首先根据传递的客户、用户ID对请求权限进行识别，只有在（一）流程中设置了客户、用户主体信息的交易请求才被允许，之后账户层交易系统会根据传递的交易编码（tradeCode）识别交易数据开户交易类型，还是交易记账类型。开户交易类型则被转发至开户子系统进行开户处理，开户子系统根据tradeCode设置的开户规则，完成注册用户账户体系的开通，如：乘客张三，会依次为其开通客户身份、打车用户身份、以及打车用户涉及的余额账户，余额返现账户，押金账户的开通。

而如果为交易记账类型，假设这里为乘客使用现金支付车费，则请求被转发至记账子系统，记账子系统根据业务线客户、用户ID、乘客业务用户ID以及tradeCode获取记账规则，完成资金逻辑记账处理。

规则涉及的账户逻辑如下：

 ![账户10](F:\work\openGuide\Architecture\png\账户\账户10.png)**记账规则** 

在账户系统中，记账规则逻辑的设计是最为复杂的一项设计，需要在兼顾会计逻辑的情况下，还需要将其设计成较为通用的规则，以上面用户支付车费的账户资金逻辑为例，如何将其设计成规则配置呢？

 ![账户11](png\账户\账户11.png)在以上记账规则表中，定义了业务线用户ID（merchUserId），表示该业务模式在系统中的唯一编码；记账交易类型（tradeCode）由具体的业务线交易模式定义，例如打车业务用户现金支付车费。这两个字段由定义客户用户信息、用户交易类型，可根据实际业务定义。

后面的字段主要定义了账户交易逻辑的情况，例如changeType中定义的记账，表示按照规则正常的借贷方向进行余额更新，而冻结、解冻则是对账户余额进行冻结、解冻操作，增加、减少是根据规则直接对账户进行增加及减少操作，之所以定义上述不同类型，主要是为了适应不同账户操作逻辑，具体定义及含义，大家也可以根据自身公司的实际业务情况进行定义。

可能这么解释大家会有比较大的疑问，我们以线上交易流程中涉及的网约车用户现金支付车费的资金逻辑为例：

![账户12](png\账户\账户12.png)根据规则表的设计，以上规则描述了各账户资金流的变动逻辑，其中涉及账户类型、借贷方向、资金类型、记账科目以及记账步骤。当业务层交易发起至账户层交易系统后，账户层交易系统会获取以上记账规则，并根据规则描述的账户类型，找到普通消费用户、平台层用户、普通服务用户对应的账户信息，并按照规则逐条进行记账逻辑执行。

**通用数据模型**

 在上面的流程及规则涉及中，以网约车业务为例，通过两个流程说明了账户系统应该如何支撑着项业务，虽然，看着并不是特别复杂，但是从系统设计上看却是涉及了很多实体信息，接下来我们从数据建模的角度，看看如何设计系统的数据模型。

 ![账户13](F:\work\openGuide\Architecture\png\账户\账户13.png)

在模型中我们根据逻辑，抽象了客户、用户、账户相关实体，同时也抽象了账户流水、科目信息、记账规则、开户规则，交易类型等信息。系统通过这些实体设计相关表结构，系统就初步具备了运转能力了，大家可以根据实际情况增加其他实体信息。

**会计科目**

会计科目是账户系统中比较基础的概念，它的定义决定了账户的一些属性特征，例如是否可透支，属于资产类or负债类，可以根据不同公司财务的需求进行设计。

**记账策略**

大家知道记账动作是强事务的，按照正常记账逻辑以上规则执行过程中涉及的4个账户更新需要具有原子性，要么都执行成功，要么全部回滚，而对于普通消费账户、普通服务账户，这些账户都属于个人账户，在线上实时交易中的并发度是有限的。而对于平台层账户，包括代收付账户、服务费账户等，平台所有的交易都涉及这些账户的资金变动，所以如果在某一个交易过程中对其加锁，会导致该账户记录的加锁-更新动作非常频繁，成为热点账户，影响系统性能。

所以在规则中我们加入了是否缓冲记账的配置，一旦配置为缓冲记账，则在执行该规则时，只是把该记账逻辑放入缓冲队列的逻辑与其他规则在一个事务中，而具体账户更新逻辑则是由缓冲记账系统完成，该逻辑可设置为日间完成，或日终完成。

从而缓解热点账户问题导致系统性能瓶颈，但是需要注意，这种方案也对缓冲记账逻辑提出了比较高的要求，需要缓冲记账系统尽量保证记账动作执行成功，一旦执行失败前面同步执行成功的记账逻辑回滚起来会比较麻烦；另外，如果之前的同步记账逻辑在发送缓冲队列成功后，自身逻辑又失败了，则需要及时发送冲正机制，取消该缓冲记账动作。

**日终对账**

为了确保账户余额始终处于相对正确地状态，需要对日终账户流水进行各种试算核对，确保所有流水发生额累加后的余额+期初余额能够与当前余额匹配，这里会涉及到比较复杂的对账逻辑，需要大家在实际系统研发实践中加以考虑。

**技术点拓展**

在账户系统的研发设计过程中，还会涉及很多其他问题，例如账户流水数据量非常大，同时数据的留存时间又要求比较长，所以需要考虑数据的分布式存储，目前小码农所在公司，采用了TIDB这种分布式数据库，大家可在实践中根据自身情况进行选择。

另外，账户的频繁更新，在系统并发量非常高的情况下，还会遇到性能瓶颈，如何在保证用户体验及数据正确性的情况下，采取更多的技术手段，如采用Redis/Codis进行缓存记账，也需要在实践应用场景中进行探索。

**后记**

由于账户系统逻辑相对比较复杂，涉及很多会计知识及细节逻辑，本文只是描述了一种理念与思路，真正做好这套账户系统还需要大家根据自身场景进行取舍与裁剪。由于作者水平有限，不足之处，还请多多包涵！

最简单

一般而言，系统内都会有用户模块，如果涉及到钱、积分、兑换券之类的，那么最好搞一套账户模块。

 简单的账户模块分为两部分，账户和流水记录。

 最简单的账户模块

在这种简单的模块内，典型的场景是用户做了某个操作，达到了预设条件，于是系统给予奖励，生成一条流水记录，该用户的账户内的金额也随之增加。用户也可以进行消费或提现，此时生成流水记录后，该用户的账户内金额是减少的。当然，用户还可以进行充值。

稍微复杂点

如果有人民币、积分、甚至美元等多个金融体系，那就要为每个用户创建一一对应的多个账户。如果涉及转换，那么一次转换就会生成两条流水记录，一条用于转出用户减少金额，另一条用户转入用户增加金额。 

不论是在系统内对账户金额做增减，还是在涉及和第三方（支付宝、微信红包，等等）进行通讯的情况下，都会存在不成功的情况。这种场景需要确定两个问题，一是如何确定是哪条流水记录失败了，二是采取哪种回滚方式。

对于第一个问题，需要给定一个序列号用于标记。简单一点的使用高精度的当前时间，还可以使用UUID、数据库中表的Sequence生成器，更复杂一点的如Twitter的snowflake，这个算法可以保证全局唯一。 

可以通过操作原始流水记录来回滚，但更优的是再创建一条反向的流水记录专门用来回滚。在信用卡上进行取消消费是使用第二种，这种方法可以保证流水记录不被修改，保持了账户操作的一致性——一条流水对应一次增减，而不是多次，利于理解。

某些生成流水的操作具有危险性，比如提现（其实提现也是一种和第三方通讯的动作，这里的第三方是各个银行）。如有必要，会对这类操作进行人工审核。那么是在生成流水前还是生成后审核呢？ 

再复杂点

对上面所提到的各个方面做综合考虑，进行细化。同时，之前的流水都是由某些动作导致的，属于“凭空产生”，系统内的总金额是不断增加的。现在虽然同样也是由某些动作引起，但是要求系统内的账户总额是相平的。 

账户

交易

首先账户分为用户账户和业务账户。业务账户初始值为0，但是可以不断透支。一个用户完成某个动作，产生的一条从对应的业务账户到该用户对应账户的交易记录。至于具体是哪个账户，可以按照需求增加，比如积分账户、红包账户、人民币账户、提现账户等等。同理，交易记录也可分为红包、充值、转账、提现等等。 

而交易记录根据是否需要审核，决定是直接生成流水记录，还是通过审核记录来生成流水记录。

虽然这样做有点绕，但也更有条理，不易出错了。

## 热点账户问题